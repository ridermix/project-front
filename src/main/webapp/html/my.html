<html>
    <head>
        <title>RPG</title>
        <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
        <link rel="stylesheet" href="/css/my.css">

    </head>

    <body onload="fillTable(0)">
        <h1>RPG admin panel</h1>
        <h2>Account list:</h2>

        <label for="countPerPage">Count per page:</label>
        <select id="countPerPage" onchange="fillTable(0)">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
        </select>
        <br>

        <div class="container mtb-3">
            <table id='table'>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Race</th>
                        <th>Profession</th>
                        <th>Level</th>
                        <th>Birthday</th>
                        <th>Banned</th>
                        <th>Edit</th>
                        <th>Deleted</th>
                    </tr>
                </thead>
            </table>
        </div>
        <br>

        <div id ="paging_buttons">Pages:&nbsp;</div>

        <hr>
        <h2>Create new account:</h2>
        <label for="input_new_name" style="font-size: 18px; margin-right: 61px"> Name:</label>
        <input type="text" id="input_new_name" name="name" required size="12" maxlength="12">
        <br>
        <br>




        <script>
            function fillTable(page_number) {

                $("tr:has(td)").remove();

                let url = "/rest/players?";
                let countPerPage = $("#countPerPage").val();
                if (countPerPage == null) {
                    countPerPage = 3;
                }
                url = url.concat("pageSize=").concat(countPerPage);

                if (page_number == null) {
                    page_number = 0;
                }
                url = url.concat("&pageNumber=").concat(page_number);

                $.get(url, function (data) {
                    $.each(data, function (key, value) {
                        $('<tr>')
                            .html('<td>' + value.id + '</td>'
                                + '<td>' + value.name + '</td>'
                                + '<td>' + value.title + '</td>'
                                + '<td>' + value.race + '</td>'
                                + '<td>' + value.profession + '</td>'
                                + '<td>' + value.level + '</td>'
                                + '<td>' + new Date(value.birthday).toLocaleDateString() + '</td>'
                                + '<td>' + value.banned + '</td>'
                                + '<td>' + "<button id='button_edit_" + value.id + "' onclick='editAccount(" + value.id + ")'>"
                                + "<img src='/img/edit.png' style=\"width: 20px; height: 20px\">"
                                + "</button>" + '</td>'
                                + '<td>' + "<button id='button_delete_" + value.id + "' onclick='deleteAccount(" + value.id + ")'>"
                                + "<img src='/img/delete.png' style=\"width: 20px; height: 20px\">"
                                + "</button>" + '</td>'
                            ).appendTo("#table");
                    });
                });

                let totalCount = getNumberOfAccount();
                let pagesCount = Math.ceil(totalCount / countPerPage);

                $("button.pgn-bnt-styled").remove();
                for (let i = 0; i < pagesCount; i++) {
                    let button_tag = "<button>" + (i + 1) + "</button>";
                    let button = $(button_tag)
                        .attr("id", "paging_button_" + i)
                        .attr("onclick", "fillTable(" + i + ")")
                        .addClass("pgn-bnt-styled");
                    $("#paging_buttons").append(button);
                }
                let identifier = "#paging_button_" + page_number;
                $(identifier).css("background", "#1e88e5").css("color", "#fff");

            }

            function getNumberOfAccount() {
                let url = "/rest/players/count";
                let res = 0;
                $.ajax({
                    url: url,
                    async: false,
                    success:function (result){
                        res = parseInt(result);
                    }
                })

                return res;
            }

            function editAccount(id) {
                let identifier_edit = "#button_edit_" + id;
                let identifier_delete = "#button_delete_" + id;

                $(identifier_delete).remove();

                let save_image_tag = "<img src='/img/save.png' style=\"width: 20px; height: 20px\">"
                $(identifier_edit).html(save_image_tag);

                // let current_tr_element = $(identifier_edit).parent().parent();
                // let child = current_tr_element.children();
                //
                // let td_name = child[1];



            }

            function deleteAccount(id) {
                let url = '/rest/players/' +id;
                $.ajax({
                    url: url,
                    type: 'DELETE',
                    success: function () {
                        fillTable(getCurrentPage());
                    }
                });
            }

            function getCurrentPage() {
                let current_page = 1;
                $('button:parent(div)').each(function () {
                    if($(this).css('color') === '#FF0000'){
                        current_page = $(this).text()
                    }
                });
                return parseInt(current_page) - 1;
            }


    // function sendRequest(method, url) {
    //     return new Promise((resolve, reject) => {
    //         let xhr = new XMLHttpRequest()
    //
    //         xhr.open(method, url)
    //         xhr.responseType = 'json'
    //         xhr.onload = () => {
    //             if (xhr.status >= 400) {
    //                 reject(xhr.response)
    //             } else {
    //                 resolve(xhr.response)
    //             }
    //         }
    //         xhr.onerror = () => {
    //             reject(xhr.response)
    //         }
    //         xhr.send()
    //     })
    // }
    //
    // sendRequest('GET', url)
    //     .then(data => console.log(data))
    //     .catch(err => console.log(err))


</script>

</body>
</html>